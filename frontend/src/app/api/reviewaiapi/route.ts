import{NextRequest,NextResponse}from'next/server';
import{loadOpenAIToken}from'@/utils/env';
const getOpenAIToken=()=>loadOpenAIToken();
export async function POST(req:NextRequest){try{const{prompt}=await req.json();if(!prompt)return NextResponse.json({error:'Prompt is required'},{status:400});const tk=getOpenAIToken();if(!tk){console.error('OpenAI API key not found in environment or token file');return NextResponse.json({error:'OpenAI API key not configured. Please add your API key to .env.local or openai_token.txt'},{status:500});}const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${tk}`,},body:JSON.stringify({model:'gpt-3.5-turbo',messages:[{role:'system',content:'You are an expert IELTS tutor. Respond in plain text format as requested by the user.'},{role:'user',content:prompt,},],temperature:0.7,max_tokens:500,}),});if(!r.ok){const et=await r.text();console.error('OpenAI API error:',r.status,et);return NextResponse.json({error:`OpenAI API error: ${r.status}`,details:et},{status:r.status});}const d=await r.json();const m=d.choices?.[0]?.message?.content||'';if(!m)return NextResponse.json({error:'No response from OpenAI'},{status:500});return NextResponse.json({generated_text:m});}catch(e){console.error('OpenAI API error:',e);return NextResponse.json({error:'Internal Server Error',details:e instanceof Error?e.message:'Unknown error'},{status:500});}}